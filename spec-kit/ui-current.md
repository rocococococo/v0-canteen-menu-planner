# 当前 UI 行为与交互说明书

**文档版本**: 1.0  
**生成日期**: 2025-11-22  
**基于代码**: v0-canteen-menu-planner 当前版本

---

## 1. 页面结构概述

### 1.1 整体布局

应用采用双列布局（桌面端）：

```
┌─────────────────────────────────────────────────────────────┐
│                      Header (桌面端)                         │
│  [2025年11月] [<] [今天] [>]  [日周月年切换] [搜索]         │
├─────────────────────────┬───────────────────────────────────┤
│                         │                                   │
│   日历视图区域           │      排菜详情面板 (Inspector)      │
│   (flex-[2])           │      (flex-1, 桌面端lg+显示)       │
│                         │                                   │
│  - MonthView (默认)     │   Header: 排菜详情 + 日期         │
│  - WeekView            │   Summary: 草稿/已提交统计         │
│  - DayView             │   Content: SessionCard 列表       │
│  - YearView            │   Footer: [新增菜单] 按钮          │
│                         │                                   │
└─────────────────────────┴───────────────────────────────────┘
```

### 1.2 核心区域

#### 1.2.1 **左侧：日历视图区域** (`CalendarShell`)
- **组件**: `components/calendar/calendar-shell.tsx`
- **作用**: 显示日期选择器，支持4种视图模式
- **子组件**:
  - `MonthView`: 月视图（默认）
  - `WeekView`: 周视图
  - `DayView`: 日视图
  - `YearView`: 年视图

#### 1.2.2 **右侧：排菜详情面板** (`Inspector`)
- **组件**: `components/calendar/inspector.tsx`
- **作用**: 显示所选日期的菜单计划编辑界面
- **显示条件**: 仅在桌面端（lg及以上）显示
- **子组件**:
  - `SessionCard`: 菜单会话卡片（可折叠）
  - `DishItem`: 菜品编辑项
  - `AddMenuForm`: 新增菜单表单（内联）

---

## 2. 关键交互流程

### 2.1 **选择日期**

**流程**:
1. 用户在任意日历视图（月/周/日/年）中点击某个日期
2. `currentDate` 状态更新（父组件 `app/page.tsx`）
3. Inspector 面板自动更新，显示该日期的排菜详情
4. 如果月视图显示菜品指示器（小圆点），则相应显示

**实际行为**:
- ✅ 日期点击响应迅速
- ✅ Inspector 立即更新
- ✅ 不会关闭或重置任何已打开的表单
- ✅ 农历信息自动更新显示

### 2.2 **新增菜单 Session**

**流程**:
1. 点击 Inspector 底部的 `[新增菜单]` 按钮
2. 展开内联表单，显示食堂和餐别选择（卡片式按钮）
3. 选择食堂（第一食堂/第二食堂/教工食堂）
4. 选择餐别（早餐/午餐/晚餐）
5. 点击 `[开始排菜]` 按钮
6. 创建新的 Session 卡片，状态为 "草稿"
7. Session 卡片自动展开，准备添加菜品
8. 表单自动关闭并重置

**实际行为**:
- ✅ 卡片式选择器有悬停和选中状态高亮
- ✅ 检查重复：同一天同一食堂同一餐别只能创建一个 Session
- ✅ 重复创建时显示 Toast 错误提示：`该经营窗口已存在`
- ✅ 成功创建后无 Toast 提示（仅视觉反馈）
- ✅ 新 Session 默认展开状态

### 2.3 **添加菜品**

**流程**:
1. 在已创建的 Session 卡片内（展开状态）
2. 点击 `[添加第一道菜]` 或 `[添加第N道菜]` 按钮
3. 新增一个空白的 `DishItem` 组件
4. 自动聚焦到菜品名称输入框

**实际行为**:
- ✅ 添加后立即可编辑
- ✅ 菜名输入框自动获得焦点
- ✅ 动态按钮文本（"添加第1道菜"、"添加第2道菜"...）
- ❌ 添加菜品后不显示 Toast 提示
- ✅ 已提交的 Session 不允许添加菜品（按钮不显示）

### 2.4 **编辑菜品信息**

**流程**:
1. 在 `DishItem` 中填写菜品信息：
   - 菜品名称（文本输入）
   - 份数（数字输入，带"份"后缀）
2. 点击 `[添加原料]` 按钮添加原料
3. 填写原料信息：
   - 原料名称
   - 数量（数字）
   - 单位（下拉选择：千克/克/升/毫升/个/包/箱/自定义）
   - 备注（可选）

**实际行为**:
- ✅ 实时保存到 Zustand store（无需点击保存按钮）
- ✅ 原料自动聚焦到名称输入框
- ✅ 支持多个原料添加
- ✅ 每个原料有独立的删除按钮
- ❌ 无表单验证（可以保存空菜名或空份数）
- ❌ 数据仅存储在内存中（刷新页面丢失）

### 2.5 **删除菜品**

**流程**:
1. 点击菜品右侧的 `[删除]` 按钮
2. 菜品立即从列表中移除

**实际行为**:
- ✅ 无二次确认
- ✅ 立即删除，无动画
- ❌ 删除后无 Toast 提示
- ❌ 无撤销功能
- ✅ 已提交的 Session 不允许删除菜品

### 2.6 **删除 Session**

**流程**:
1. 点击 Session 卡片头部的 `[删除]` 按钮
2. 按钮文字变为 `确认删除?`，背景变红
3. 再次点击确认删除
4. Session 从列表中移除
5. 3秒内不点击则自动取消

**实际行为**:
- ✅ 二次确认机制（内联确认，非弹窗）
- ✅ 3秒后自动重置为普通删除按钮
- ✅ 点击其他地方（如关闭/展开）会重置确认状态
- ❌ 删除后无 Toast 提示
- ❌ 无撤销功能

### 2.7 **提交菜单**

**流程**:
1. 在 Session 卡片底部点击蓝色的 `[提交菜单]` 按钮
2. 按钮文字变为 `确认提交菜单? (无法撤销)`，背景变红
3. 再次点击确认提交
4. Session 状态变更为 "已提交"（蓝色徽章）
5. Session 卡片自动折叠
6. 显示 Toast 成功提示：`菜单已提交`
7. 所有编辑功能被锁定

**实际行为**:
- ✅ 二次确认机制
- ✅ 3秒后自动重置为普通提交按钮
- ✅ 提交后显示 Toast 成功反馈
- ✅ 自动折叠卡片
- ✅ 状态徽章从红色"草稿"变为蓝色"已提交"
- ✅ 已提交后不可编辑、不可添加菜品、不可删除菜品
- ⚠️ 提交后仍可删除整个 Session
- ❌ 无实际后端提交（数据仅在内存）

### 2.8 **视图切换**

**流程**:
1. 点击顶部的视图切换按钮（日/周/月/年）
2. 视图立即切换
3. 保持当前选中的日期不变

**实际行为**:
- ✅ 切换流畅，无延迟
- ✅ 所有视图都显示农历信息
- ✅ Inspector 面板内容不受影响

### 2.9 **日期导航**

**流程**:
1. 使用顶部的 `[<]` `[今天]` `[>]` 按钮
2. 日期相应前进/后退或回到今天

**实际行为**:
- ✅ `[<]` / `[>]` 按钮根据当前视图智能跳转：
  - 年视图：±1年
  - 月视图：±1月
  - 周视图：±7天
  - 日视图：±1天
- ✅ `[今天]` 按钮立即跳转到当天
- ✅ Inspector 自动更新

---

## 3. 当前已实现的功能

### 3.1 UI 层已实现

| 功能 | 状态 | 说明 |
|------|------|------|
| 日历视图切换 | ✅ | 4种视图（日/周/月/年）完全可用 |
| 日期选择 | ✅ | 所有视图都支持点击选择 |
| 农历信息显示 | ✅ | 所有视图+Inspector都显示农历、节假日、节气 |
| 新增菜单 Session | ✅ | 卡片式选择器，支持3个食堂×3个餐别 |
| Session 管理 | ✅ | 创建、删除、折叠/展开、状态切换 |
| 菜品添加 | ✅ | 动态添加菜品到 Session |
| 菜品编辑 | ✅ | 实时编辑菜名、份数 |
| 原料管理 | ✅ | 添加、编辑、删除原料 |
| 菜品删除 | ✅ | 即时删除 |
| 菜单提交 | ✅ | 二次确认 + 状态锁定 |
| Toast 通知 | ✅ | 使用 Sonner |
| 重复检测 | ✅ | 同一天同一食堂同一餐别只能有一个 Session |
| 数据统计 | ✅ | Inspector 头部显示草稿/已提交数量 |
| 空状态提示 | ✅ | 无菜单时显示引导文案 |
| 今日高亮 | ✅ | 当天日期用红色圆圈突出显示 |
| 悬停效果 | ✅ | 所有可点击元素都有 hover 状态 |

### 3.2 数据层实现

| 功能 | 状态 | 说明 |
|------|------|------|
| 状态管理 | ✅ | 使用 Zustand |
| Session CRUD | ✅ | 增删改查完整实现 |
| Dish CRUD | ✅ | 增删改查完整实现 |
| 数据持久化 | ❌ | **仅内存存储，刷新丢失** |
| 后端API | ❌ | **无后端，纯前端** |

### 3.3 假数据/占位符

| 项目 | 状态 | 说明 |
|------|------|------|
| 厨师名称 | 📋 | 硬编码为 `"当前厨师"` |
| 食堂列表 | 📋 | 硬编码3个：第一食堂、第二食堂、教工食堂 |
| 餐别列表 | 📋 | 硬编码3个：早餐、午餐、晚餐 |
| 菜品ID | ⚠️ | 使用 `Math.random().toString(36)` 生成（不安全） |
| Session ID | ⚠️ | 同上 |
| 原料ID | ⚠️ | 同上 |

---

## 4. 当前未实现的功能

### 4.1 数据相关

- ❌ **数据持久化**: 刷新页面后所有数据丢失
- ❌ **后端API**: 无实际的增删改查请求
- ❌ **数据导入/导出**: 无法导入历史数据或导出当前数据
- ❌ **草稿自动保存**: 无周期性自动保存
- ❌ **撤销/重做**: 无操作历史记录

### 4.2 验证相关

- ❌ **表单验证**: 可以提交空菜名、空份数
- ❌ **数字范围验证**: 份数可以输入负数或超大数值
- ❌ **重复菜品检测**: 同一Session可以有多个同名菜品
- ❌ **必填项提示**: 无红色星号或错误提示

### 4.3 交互增强

- ❌ **搜索功能**: 搜索框UI存在但无实际功能
- ❌ **批量操作**: 无批量删除、批量提交
- ❌ **拖拽排序**: 菜品顺序固定，无法调整
- ❌ **复制/粘贴**: 无法复制昨天的菜单到今天
- ❌ **快捷键**: 无键盘快捷键支持

### 4.4 视图增强

- ❌ **月视图菜单预览**: 日期上虽有圆点指示器，但未显示具体菜单摘要
- ❌ **打印视图**: 无打印友好的格式
- ❌ **导出PDF**: 无导出功能
- ❌ **菜品图片**: 无图片上传功能

### 4.5 统计分析

- ❌ **营养分析**: 无营养成分计算
- ❌ **成本估算**: 无成本统计
- ❌ **历史数据图表**: 无趋势分析
- ❌ **报表生成**: 无周报/月报

---

## 5. 状态与反馈

### 5.1 有反馈的操作

| 操作 | 反馈类型 | 内容 |
|------|----------|------|
| 重复创建 Session | Toast Error | "该经营窗口已存在" |
| 提交菜单 | Toast Success | "菜单已提交" |
| 删除 Session/菜品 | UI 确认按钮 | 按钮文字变为"确认删除?" + 红色 |
| 提交菜单 | UI 确认按钮 | 按钮文字变为"确认提交菜单? (无法撤销)" + 红色 |
| 悬停可点击元素 | CSS 悬停效果 | 背景色/文字色变化 |
| Session 提交后 | 状态徽章 | 从红色"草稿"变为蓝色"已提交" |
| Session 提交后 | 自动折叠 | 卡片自动收起 |

### 5.2 无反馈的操作

| 操作 | 缺少的反馈 |
|------|-----------|
| 成功创建 Session | 无 Toast 提示 |
| 添加菜品 | 无 Toast 提示 |
| 删除菜品 | 无 Toast 提示，无确认对话框 |
| 编辑菜品名称/份数 | 无保存成功提示（实时保存，但用户感知弱） |
| 添加原料 | 无 Toast 提示 |
| 删除原料 | 无 Toast 提示，无确认对话框 |

### 5.3 反馈改进建议

1. **建议添加**:
   - 成功创建 Session 的轻量提示
   - 菜品删除的轻量确认（或Toast撤销选项）
   - 原料数量为0或负数的验证提示

2. **建议保留**:
   - Session/菜单删除的二次确认机制很好
   - Toast不宜过多，避免打扰

---

## 6. 组件关系图（文本形式）

```
app/page.tsx (根页面)
└── CalendarShell
    ├── Header (桌面端)
    │   ├── 日期导航 (< 今天 >)
    │   ├── 视图切换按钮 (日/周/月/年)
    │   └── 搜索框 (占位符)
    │
    ├── 视图区域 (根据 view 状态动态渲染)
    │   ├── MonthView (默认)
    │   │   └── DayCell (每个日期单元格)
    │   │       ├── 显示阳历日期
    │   │       ├── 显示农历信息
    │   │       └── 显示菜品指示器(圆点)
    │   │
    │   ├── WeekView
    │   │   ├── 周头部 (显示7天+农历)
    │   │   └── WeekDayColumn × 7
    │   │       └── 菜品条目列表
    │   │
    │   ├── DayView
    │   │   ├── 日期标题 + 农历
    │   │   └── DayViewSessionCard × N
    │   │       └── 显示菜品列表（只读）
    │   │
    │   └── YearView
    │       └── MonthGrid × 12
    │           └── 每个日期 + 农历信息
    │
    └── Inspector (右侧面板, lg+显示)
        ├── Header
        │   ├── 标题: "排菜详情"
        │   ├── 日期: 阳历 + 农历 + 节日/节气
        │   └── 统计: 草稿数 / 已提交数
        │
        ├── Content (ScrollArea)
        │   ├── SessionCard × N (可折叠卡片)
        │   │   ├── CardHeader
        │   │   │   ├── 食堂名 - 餐别名
        │   │   │   ├── 状态徽章 (草稿/已提交)
        │   │   │   ├── 菜品数量统计
        │   │   │   └── [删除] 按钮
        │   │   │
        │   │   └── CardContent (展开时显示)
        │   │       ├── DishItem × M
        │   │       │   ├── 菜品名称输入
        │   │       │   ├── 份数输入
        │   │       │   ├── [删除菜品] 按钮
        │   │       │   └── Ingredients Section
        │   │       │       ├── IngredientRow × K
        │   │       │       │   ├── 原料名称
        │   │       │       │   ├── 数量
        │   │       │       │   ├── 单位下拉
        │   │       │       │   ├── 备注
        │   │       │       │   └── [删除原料] 按钮
        │   │       │       └── [添加原料] 按钮
        │   │       │
        │   │       ├── [添加第N道菜] 按钮 (有菜品时显示)
        │   │       ├── [添加第一道菜] 按钮 (空状态时显示)
        │   │       └── [提交菜单] 按钮 (草稿状态时显示)
        │   │
        │   └── AddMenuForm (内联表单, isAddingMenu=true时显示)
        │       ├── [X] 关闭按钮
        │       ├── 食堂选择 (卡片式按钮组)
        │       ├── 餐别选择 (卡片式按钮组)
        │       └── [开始排菜] 按钮
        │
        └── Footer
            └── [新增菜单] 按钮 (虚线边框)
```

### 6.1 数据流

```
app/page.tsx (currentDate state)
    │
    ├─► CalendarShell (接收 currentDate, onDateChange)
    │       │
    │       ├─► MonthView/WeekView/DayView/YearView
    │       │   └─► 点击日期 → 调用 onDateChange
    │       │
    │       └─► Inspector (接收 currentDate)
    │           └─► useMenuStore (Zustand)
    │               ├─► sessions: MenuSession[]
    │               ├─► addSession()
    │               ├─► updateSession()
    │               ├─► removeSession()
    │               ├─► addDish()
    │               ├─► updateDish()
    │               └─► removeDish()
    │
    └─► 数据存储: Zustand store (仅内存, 无持久化)
```

### 6.2 关键状态

**全局状态 (Zustand)**:
- `sessions: MenuSession[]` - 所有菜单会话

**CalendarShell 本地状态**:
- `view: ViewMode` - 当前视图模式
- `isSearchOpen: boolean` - 搜索框展开状态

**Inspector 本地状态**:
- `isAddingMenu: boolean` - 是否显示新增表单
- `selectedCanteen: string` - 选中的食堂
- `selectedMeal: string` - 选中的餐别

**SessionCard 本地状态**:
- `isOpen: boolean` - 折叠/展开状态
- `isConfirmingDelete: boolean` - 删除确认状态
- `isConfirmingSubmit: boolean` - 提交确认状态

---

## 7. 特殊行为与约定

### 7.1 自动行为

1. **Session 提交后自动折叠**: 当 `status` 变更为 `"submitted"` 时，`useEffect` 自动设置 `isOpen = false`
2. **新添加的菜品自动聚焦**: `DishItem` 的菜品名称输入框有 `autoFocus` 属性
3. **新添加的原料自动聚焦**: 原料名称输入框有 `autoFocus` 属性
4. **确认按钮3秒自动重置**: 删除/提交确认按钮使用 `setTimeout` 在3秒后重置状态

### 7.2 条件渲染

1. **Inspector 仅桌面显示**: 使用 `hidden lg:block` 类，移动端不显示
2. **已提交 Session 锁定**: `isLocked = session.status === "submitted"` 时隐藏所有编辑按钮
3. **空状态提示**: `sessions.length === 0 && !isAddingMenu` 时显示空状态
4. **动态按钮文本**: "添加第N道菜" 根据 `session.dishes.length + 1` 动态生成

### 7.3 ID 生成

⚠️ **当前使用不安全的随机ID生成**:
```typescript
Math.random().toString(36).substr(2, 9)
```
- 优点: 简单快速
- 缺点: 可能重复，不适合生产环境

**建议**: 使用 `crypto.randomUUID()` 或 `nanoid` 库

---

## 8. 已知问题与限制

### 8.1 数据安全

- ❌ 数据仅存储在内存中，刷新页面丢失
- ❌ ID 生成不安全，可能产生重复
- ❌ 无数据备份机制

### 8.2 用户体验

- ⚠️ 删除菜品无二次确认，容易误操作
- ⚠️ 删除原料无二次确认
- ⚠️ 搜索框无实际功能，可能造成用户困惑

### 8.3 性能

- ✅ 使用 `React.useMemo` 优化 session 过滤
- ⚠️ MonthView 渲染42个日期单元格，每个单元格都调用 `useMenuStore`，可能有性能影响

### 8.4 响应式

- ⚠️ Inspector 在移动端完全隐藏，移动端用户无法编辑菜单
- ✅ 日历视图在移动端有独立的头部和底部导航（但未完全实现）

---

## 附录：技术栈说明

- **框架**: Next.js 16 (App Router)
- **状态管理**: Zustand
- **UI 库**: shadcn/ui (基于 Radix UI)
- **样式**: Tailwind CSS
- **日期处理**: date-fns
- **农历**: lunar-typescript
- **Toast**: Sonner
- **图标**: Lucide React

---

**文档结束**

_本文档基于当前代码实际行为编写，不包含任何未实现的功能或理想化设计。如代码更新，请相应更新本文档。_
