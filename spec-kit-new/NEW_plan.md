# Delivery Plan (API-First) — 2025-11-22

## 基线 (v0 已有)
- 桌面端日/周/月/年视图、农历、导航；Inspector 管理 Session/Dish/Ingredient；重复校验；提交锁定；Zustand 内存。
- 当前缺口：无持久化/鉴权/搜索/校验；移动端无编辑。

## v0.1 — 数据库接入与 API 持久化（首要）
- 接入 PostgreSQL + Prisma，定义 Session/Dish/Ingredient 表。
- 提供 `/api/v1/sessions` CRUD 与提交/删除端点；幂等防重复创建。
- 前端改为调用 API，使用乐观更新 + 回滚；停止依赖内存作为真源（内存仅作缓存）。
- ID 改为 uuid；保持现有 UI 流与状态机不变。

## v0.2 — 鉴权与作用域
- 引入基础登录（NextAuth/JWT 均可），实现最小角色：planner（可写所属窗口）、viewer（只读）。
- 用户/角色/权限/作用域落库；所有 API 验证作用域与权限。
- 审计表记录操作（actor、业务键、前后状态摘要）。

## v0.3 — 体验硬化
- 表单校验（必填、非负数）与提交流程阻断。
- 搜索/过滤落地：按食堂/餐别/菜名过滤 Inspector + 视图指示。
- 成功/删除 toast 与撤销窗口；移动端提供等效编辑面板。

## 未来版本 (Roadmap)
- 采购/供应商指派/采购单、验收、销售导入、分析报表。
- 高级 RBAC（自定义权限集）、指标与限流、文件上传（菜品图片/验收凭证）。
- 对接智慧食堂 API：入站数据表、任务调度、差异对账。

## 废弃/重写
- 旧 plan 中的后台多模块实施顺序暂不适用，统一迁移到 Roadmap，待后台立项时重写。

## 里程碑与顺序
- 里程碑 1：完成 v0.1（DB+API）作为新真源；无此先决不做上层功能。
- 里程碑 2：完成 v0.2（鉴权+审计），确保数据安全后再做体验增强。
- 里程碑 3：完成 v0.3（搜索/校验/移动端/反馈）。

## 风险与对策
- 迁移期数据丢失：先做一次性内存→DB 迁移脚本（无历史时可跳过）。
- API 性能：日历视图需按日期聚合返回轻量摘要，避免过度渲染。
- 鉴权复杂度：先两角色，避免过早自定义矩阵；接口预留权限检查钩子。
